@model GlamCentral.Models.Agenda
@{
	ViewBag.Title = "Agenda";
}

<br />
<br />
<br />

<div id="calender"></div>

<div id="myModal" class="modal fade" role="dialog">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<div>
					<h4 class="modal-title"><span id="eventTitle"></span></h4>

				</div>
				<div>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
			</div>
			<div class="modal-body">
				<button id="btnDelete" class="btn btn-secondary btn-red btn-sm pull-right">
					<span class="glyphicon glyphicon-remove"></span> Excluir
				</button>
				<button id="btnEdit" class="btn btn-secondary btn-orange btn-sm pull-right" style="margin-right:5px;">
					<span class="glyphicon glyphicon-pencil"></span> Editar
				</button>
				<p id="pDetails"></p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary btn-btn-light-green" data-dismiss="modal">Fechar</button>
			</div>
		</div>
	</div>
</div>

<div id="myModalSave" class="modal fade" role="dialog">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<div>
					<h4 class="modal-title">Salvar</h4>
				</div>
				<div>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
			</div>
			<div class="modal-body">
				<form class="col-md-12 form-horizontal">
					@Html.AntiForgeryToken()
					<input type="hidden" id="hdEventID" value="0" />
					<div class="form-group">
						<label>Dia</label>
						@*<div class="input-group date" id="dtp1">*@
						<input asp-for="Start" id="txtStart" class="form-control" placeholder="dd/mm/aaaa">
						<span asp-validation-for="Start" class="text-danger"></span>
						@*<input type="text" id="txtStart" class="form-control" />
							<span class="input-group-addon">
							<span class="glyphicon glyphicon-calendar"></span>
							</span>*@
						@*</div>*@
					</div>
					<div class="form-group col-md-6">
						<label asp-for="FuncionarioId"></label>
						<select asp-for="FuncionarioId" class="form-control" id="funcionarioSelected" asp-items="@ViewBag.Funcionarios">
							<option value="">Selecione ...</option>
						</select>
						<span asp-validation-for="FuncionarioId" class="text-danger"></span>
					</div>
					<div class="form-group col-md-6">
						<label asp-for="ClienteId"></label>
						<select asp-for="ClienteId" class="form-control" id="clienteSelected" asp-items="@ViewBag.Clientes">
							<option value="">Selecione ...</option>
						</select>
						<span asp-validation-for="ClienteId" class="text-danger"></span>
					</div>
					<div class="form-group col-md-6">
						<label asp-for="ProcedimentoId"></label>
						<select asp-for="ProcedimentoId" class="form-control" id="procedimentoSelected" asp-items="@ViewBag.Procedimentos">
							<option value="">Selecione ...</option>
						</select>
						<span asp-validation-for="ProcedimentoId" class="text-danger"></span>
					</div>					
					<div class="form-group">
						<div class="checkbox">
							<label><input type="checkbox" id="chkIsFullDay" checked="checked" />  Dia todo </label>
						</div>
					</div>
					<div class="form-group" id="divDuration" style="display:none">
						<label>Duração</label>
						@*<div class="input-group date" id="dtp2">*@
						<input asp-for="Duration" id="txtDuration" class="form-control" placeholder="dd/mm/aaaa">
						<span asp-validation-for="Duration" class="text-danger"></span>
						@*<span class="input-group-addon">
							<span class="glyphicon glyphicon-calendar"></span>
							</span>
							</div>*@
					</div>
					<div class="form-group">
						<label>Descrição</label>
						<textarea id="txtDescription" rows="3" class="form-control"></textarea>
					</div>
					<div class="form-group">
						<label>Cor</label>
						<select id="ddThemeColor" class="form-control">
							<option value="">Padrão</option>
							<option value="#F5AD98">Laranja</option>
							<option value="#00DB78">Verde</option>
							<option value="#FFF261">Amarelo</option>
						</select>
					</div>
					<button type="button" id="btnSave" class="btn btn-success">Salvar</button>
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
				</form>
			</div>
		</div>
	</div>
</div>

<link href="/resources/lib/FullCalendar/bootstrap-4.17.47/css/fullcalendar.min.css" rel="stylesheet" />
<link href="/resources/lib/FullCalendar/bootstrap-4.17.47/css/fullcalendar.print.css" rel="stylesheet" media="print" />
<link href="/resources/lib/FullCalendar/bootstrap-4.17.47/css/bootstrap-datetimepicker.min.css" rel="stylesheet" />

@section Scripts{
<script src="/resources/lib/FullCalendar/js/moment.min.js"></script>
<script src="/resources/lib/FullCalendar/js/fullcalendar.min.js"></script>
<script type="text/javascript" src="/resources/lib/FullCalendar/js/bootstrap-datetimepicker.min.js"></script>
<script>
	$(document).ready(function () {
		var events = [];
		var selectedEvent = null;
		FetchEventAndRenderCalendar();
		function FetchEventAndRenderCalendar() {
			events = [];
			$.ajax({
				type: "GET",
				url: "/Funcionario/Agenda/Buscar",
				success: function (data) {
					$.each(data, function (i, v) {
						events.push({
							Id: v.id,
							title: v.subject,
							description: v.description,
							start: moment(v.start),
							end: v.end != null ? moment(v.end) : null,
							color: v.themeColor,
							allDay: v.isFullDay
						});
					})

					GenerateCalender(events);
				},
				error: function (error) {
					alert('failed');
				}
			})
		}

		function GenerateCalender(events) {
			$('#calender').fullCalendar('destroy');
			$('#calender').fullCalendar({
				//contentHeight: auto,
				defaultDate: new Date(),
				monthNames: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'],
				monthNamesShort: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
				dayNames: ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sabado'],
				dayNamesShort: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'],
				timeFormat: 'h(:mm)a',
				buttonText: {
					today: 'hoje',
					month: 'mês',
					week: 'semana',
					day: 'dia'
				},
				header: {
					left: 'prev,next today',
					center: 'title',
					right: 'month,basicWeek,basicDay,agenda'
				},
				eventLimit: true,
				eventColor: '#eb9195',
				events: events,
				eventClick: function (calEvent, jsEvent, view) {
					selectedEvent = calEvent;
					$('#myModal #eventTitle').text(calEvent.title);
					var $description = $('<div/>');
					$description.append($('<p/>').html('<br /><br /><b>    Data: </b>' + calEvent.start.format("DD-MMM-YYYY HH:mm a")));
					if (calEvent.end != null) {
						$description.append($('<p/>').html('<b>    Duração: </b>' + calEvent.end.format("DD-MMM-YYYY HH:mm a")));
					}
					$description.append($('<p/>').html('<b>    Descrição: </b>' + calEvent.description));
					$('#myModal #pDetails').empty().html($description);

					$('#myModal').modal();
				},
				selectable: true,
				select: function (start, end) {
					selectedEvent = {
						id: 0,
						title: '',
						description: '',
						start: start,
						end: end,
						allDay: false,
						color: ''
					};
					openAddEditForm();
					$('#calendar').fullCalendar('unselect');
				},
				editable: true,
				eventDrop: function (event) {
					var data = {
						Id: event.id,
						Subject: event.title,
						Start: event.start.format('DD/MM/YYYY HH:mm A'),
						End: event.end != null ? event.end.format('DD/MM/YYYY HH:mm A') : null,
						Description: event.description,
						ThemeColor: event.color,
						IsFullDay: event.allDay
					};
					SaveEvent(data);
				}
			})
		}

		$('#btnEdit').click(function () {
			//Open modal dialog for edit event
			openAddEditForm();
		})
		$('#btnDelete').click(function () {
			var data = {'id': selectedEvent.Id};
			data.__RequestVerificationToken = $('input[name="__RequestVerificationToken"]').val();
			if (selectedEvent != null) {
			$.ajax({
				type: "POST",
				url: '/Funcionario/Agenda/Excluir',
				data: data,
				success: function (status) {
					if (status) {
						//Refresh the calender
						FetchEventAndRenderCalendar();
						$('#myModal').modal('hide');
					}
				},
				error: function () {
					alert('Failed');
				}
			})
		}
		})

		//$('#dtp1,#dtp2').datetimepicker({
		//	format: 'DD/MM/YYYY HH:mm A'
		//});

		$('#chkIsFullDay').change(function () {
			if ($(this).is(':checked')) {
				$('#divDuration').hide();
			}
			else {
				$('#divDuration').show();
			}
		});

		function openAddEditForm() {
			if (selectedEvent != null) {
				$('#hdEventID').val(selectedEvent.Id);
				$('#txtStart').val(selectedEvent.start.format('DD/MM/YYYY HH:mm A'));
				$('#chkIsFullDay').prop("checked", selectedEvent.allDay || false);
				$('#chkIsFullDay').change();
				$('#txtDuration').val(selectedEvent.end != null ? selectedEvent.end.format('DD/MM/YYYY HH:mm A') : '');
				$('#txtDescription').val(selectedEvent.description);
				$('#ddThemeColor').val(selectedEvent.color);
			}
			$('#myModal').modal('hide');
			$('#myModalSave').modal();
		}

		$('#btnSave').click(function () {
			//Validation/
			if ($('#txtStart').val().trim() == "") {
				alert('Start date required');
				return;
			}
			if ($('#chkIsFullDay').is(':checked') == false && $('#txtDuration').val().trim() == "") {
				alert('End date required');
				return;
			}
			else {
				var startDate = moment($('#txtStart').val(), "DD/MM/YYYY HH:mm A").toDate();
				var endDate = moment($('#txtDuration').val(), "DD/MM/YYYY HH:mm A").toDate();
				if (startDate > endDate) {
					alert('Invalid end date');
					return;
				}
			}

			var data = {
				Id: $('#hdEventID').val(),
				FuncionarioId: $('#funcionarioSelected').val(),
				ClienteId: $('#clienteSelected').val(),
				ProcedimentoId: $('#procedimentoSelected').val(),
				Start: $('#txtStart').val().trim(),
				End: $('#chkIsFullDay').is(':checked') ? null : $('#txtDuration').val().trim(),
				Description: $('#txtDescription').val(),
				ThemeColor: $('#ddThemeColor').val(),
				IsFullDay: $('#chkIsFullDay').is(':checked')
			}
			data.__RequestVerificationToken = $('input[name="__RequestVerificationToken"]').val();
			SaveEvent(data);
			// call function for submit data to the server
		})

		function SaveEvent(data) {
			$.ajax({
				type: "POST",
				url: '/Funcionario/Agenda/Cadastrar',
				data: data,
				success: function (status) {
					if (status) {
						//Refresh the calender
						FetchEventAndRenderCalendar();
						$('#myModalSave').modal('hide');
					}
				},
				error: function () {
					alert('Failed');
				}
			})
		}
	})
</script>
}
